express 
[[3 RESTful API's using Express]]

---------
[[#Create a project and install express]]
[[#node monitor]]
[[#Environment Variables]]
[[#Route parameters]]
[[#query string parameters]]
[[#Get a single course from the list]]
[[#POST]]
[[#input validation]]
[[#`joi` modul]]





----------
This framework gives our app a proper structure
https://www.npmjs.com/package/express

# Create a project and install express
```bash
$ mkdir express-demo
$ cd express-demo
$ npm init --yes
$ npm i express
$ vim index.js
```
http://expressjs.com/en/4x/api.html

index.js
```javascript
const express = require('express') ;

// by convention use the name 'app'
const app = express() ; // express return an object of type Express
// app.get(), app.post(), app.put(), app.delete()

app.get('/', (req, res) => {
	res.send('Hello World');
}) ;

app.get('/api/courses', (req,res) => {
	res.send([1,2,3]) ;
}) ;


app.listen(3000, () => console.log('Listening on the port 3000')) ;
```

---
# node monitor
Thanks to that module you won't to stop server

#### `npm install -g nodemon` 

and now to start your application 
#### `nodemon index.js`

--------
# Environment  Variables
port `3000` is available in your local machine but in production mode this port may be not available
The number of port should be read outside the application => use `process` object to do that:
`const port = process.env.PORT || 3000;` - this means: use an available port or port 3000

```js
//...
  

const port = process.env.PORT || 3000

app.listen(port, () => console.log(`Listening on the port ${port}...`)) ;

/////////////
output:
[nodemon] starting `node index.js`
Listening on the port 3000...
```
it will be `3000` because you have no `PORT` environment variable.

You can set that variable (on windows `set`) `export PORT=5000`
```js
$ export PORT=5000
$ nodemon index.js
[nodemon] 2.0.22
[nodemon] to restart at any time, enter `rs`
[nodemon] watching path(s): *.*
[nodemon] watching extensions: js,mjs,json
[nodemon] starting `node index.js`
Listening on the port 5000...
```

---------
## Route parameters
Use it for essential or required values
#### `req.params`

in api address send  `id` and display that number in the browser:
```js
app.get('/api/courses/:id', (req, res) => {
	res.send(req.params.id) ;
})
```

multple params :
```js
app.get('/api/posts/:year/:month', (req, res) => {
	res.send(req.params) ;
})

//--------------------------
output: object `req.params`
{"year":"2019","month":"11"}
```

---
## query string parameters
Use them for anything that is optional
#### `req.query`

You use it to provide additional data for our backend services
e.g. all posts from 2019, november sorted by name
`localhost:3000/api/posts/2019/11?sortBy=name`

```js
app.get('/api/posts/:year/:month', (req, res) => {
	res.send(req.query) ;
})

//-------
output
{"sortBy":"name"}
```

-----
## Get a single course from the list
```js
const express = require('express') ;
// by convention use the name 'app'
const app = express() ; // express return an object of type Express
  
const courses = [
	{id: 1, name: 'course1'} ,
	{id: 2, name: 'course2'} ,
	{id: 3, name: 'course3'} ,
];

app.get('/api/courses', (req,res) => {
	res.send(courses) ;
}) ;

app.get('/api/courses/:id', (req, res) => {
	const course = courses.find(c => c.id === parseInt(req.params.id) )
	if (!course) {
	res.status(404).send("The course with the given ID was not found")
	}

	res.send(course) ;

}) ;
```

------
# POST
install `postman`

`app.use(express.json())` 
	- `express.json()` returns a [[middleware]] 
```js
const express = require('express') ;
const app = express() ; // express return an object of type Express
app.use(express.json()) ;


const courses = [
	{id: 1, name: 'course1'} ,
	{id: 2, name: 'course2'} ,
	{id: 3, name: 'course3'} ,
];
  

app.post('/api/courses', (req, res) => {
	const course = {
		id: courses.length + 1,
		name: req.body.name
	}
	courses.push(course) ;
	res.send(course) ;
}) ;
```

In Postman
1. `POST`
2. `http://localhost:3000/api/courses`
3. `body` 
	1. `raw`
	2. `json`

--------
# input validation

by hand:
```js
app.post("/api/course", (req,res)=> {
	if (!req.body.name || req.body.name.length < 3){
		// # 400 bad request
		res.status(400).send("bad request") ;
		return ;
	} 
})
```

#node/joi
in a complex app better way is to use 
#### `joi` modul
https://www.npmjs.com/package/joi

### `npm i joi`

```js
const Joi = require("joi") ; // write `Joi` because require returns a class
const express = require('express') ;

app.post('/api/courses', (req, res) => {
	const schema = Joi.object( {
		name: Joi.string().min(3).required()
	}) ;

const result = schema.validate(req.body)
console.log(result) ;

if (result.error){
	//res.status(400).send(result.error) ;
	res.status(400).send(result.error.details[0].message) ;
	return ;
}
```


---
```js
const Joi = require("joi") ; // write `Joi` because require returns a class

  

const express = require('express') ;

  

// by convention use the name 'app'

const app = express() ; // express return an object of type Express

app.use(express.json()) ;

  

const courses = [

{id: 1, name: 'course1'} ,

{id: 2, name: 'course2'} ,

{id: 3, name: 'course3'} ,

];

  

app.get('/', (req, res) => {

res.send('Hello World!!!!');

}) ;

  

app.get('/api/courses', (req,res) => {

res.send(courses) ;

}) ;

  

app.get('/api/courses/:id', (req, res) => {

const course = courses.find(c => c.id === parseInt(req.params.id) )

if (!course) {

res.status(404).send("The course with the given ID was not found")

}

res.send(course) ;

}) ;

  

app.post('/api/courses', (req, res) => {

// const schema = Joi.object( {

// name: Joi.string().min(3).required()

// }) ;

// const result = schema.validate(req.body)

// //console.log(result) ;

const { error } = validateCourse(req.body) ;

if (error){

//res.status(400).send(result.error) ;

res.status(400).send(error.details[0].message) ;

return ;

}

const course = {

id: courses.length + 1,

name: req.body.name

};

  

courses.push(course) ;

res.send(course) ;

  
  

}) ;

  

// update course:

app.put('/api/courses/:id', (req, res) => {

//look up the courses

// if not existing, return 404

const course = courses.find(c => c.id === parseInt(req.params.id)) ;

if (!course) res.status(404).send('the course with the given id was not found') ;

  

// validate

//if invalid, return 400

// const schema = Joi.object( {

// name: Joi.string().min(3).required()

// }) ;

// const result = schema.validate(req.body)

// console.log(result) ;

//instead of this code above :

//const result = validateCourse(req.body)

const { error } = validateCourse(req.body)

if (error){

//res.status(400).send(result.error) ;

res.status(400).send(error.details[0].message) ;

return ;

}

  

//update course

//return the updated course

course.name = req.body.name ;

res.send(course) ;

}) ;

  

function validateCourse(course){

const schema = Joi.object( {

name: Joi.string().min(3).required()

}) ;

return schema.validate(course) ;

}

  

const port = process.env.PORT || 3000

app.listen(port, () => console.log(`Listening on the port ${port}...`)) ;
```






